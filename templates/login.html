<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sigma Chat — Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</head>
<body>
  <div class="auth-card">
    <div class="brand">
      <img src="{{ url_for('static', filename='assets/logo.png') }}" alt="Sigma Logo" class="brand__logo-img">
      <div class="brand__title">Sigma Chat</div>
    </div>

    <h1>Welcome back</h1>
    <p class="subtitle">Sign in to continue your conversations.</p>

    <div id="alert" class="alert" style="display:none"></div>

    <div class="field">
      <div class="label"><span>Phone</span></div>
      <div class="input-wrap">
        <input id="phone" class="input" type="tel" placeholder="+91XXXXXXXXXX" autocomplete="tel" required>
      </div>
    </div>

    <div class="field">
      <div class="label"><span>Password</span></div>
      <div class="input-wrap">
        <input id="password" class="input" type="password" placeholder="Your password" autocomplete="current-password" required>
        <i id="togglePwd" class="bi bi-eye eye"></i>
      </div>
    </div>

    <div class="actions">
      <button id="btnLogin" class="btn">Login</button>
      <button id="btnClear" class="btn secondary" type="button">Clear</button>
    </div>

    <div class="meta">
      New here? <a href="{{ url_for('signup') }}">Create an account</a>
    </div>
  </div>

  <script type="module">
    import { ApiClient } from "{{ url_for('static', filename='js/apiClient.js') }}";
    import { Prefs } from "{{ url_for('static', filename='js/prefs.js') }}";

    const phoneEl = document.getElementById('phone');
    const passEl  = document.getElementById('password');
    const btn     = document.getElementById('btnLogin');
    const clear   = document.getElementById('btnClear');
    const alertEl = document.getElementById('alert');
    const toggle  = document.getElementById('togglePwd');

    toggle.addEventListener('click', () => {
      const isHidden = passEl.type === 'password';
      passEl.type = isHidden ? 'text' : 'password';
      toggle.className = isHidden ? 'bi bi-eye-slash eye' : 'bi bi-eye eye';
    });

    clear.addEventListener('click', () => { 
      phoneEl.value=''; passEl.value=''; alertEl.style.display='none'; 
    });

    async function doLogin() {
      const phone = phoneEl.value.trim();
      const password = passEl.value.trim();
      if (!phone || !password) { err('Please fill phone and password.'); return; }

      btn.disabled = true; info('Signing in…');
      try {
        const r = await ApiClient.login(phone, password);
        Prefs.saveToken(r.access_token);
        Prefs.saveUserId(r.user_id);
        Prefs.saveUserName(r.name || '');
        Prefs.savePhone(r.phone || '');
        window.location.href = "{{ url_for('home') }}";
      } catch (e) { err(e.message || 'Login failed'); }
      finally { btn.disabled = false; }
    }

    btn.addEventListener('click', doLogin);
    passEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') doLogin(); });

    function err(msg){ alertEl.className='alert error'; alertEl.textContent=msg; alertEl.style.display='block'; }
    function info(msg){ alertEl.className='alert ok';    alertEl.textContent=msg; alertEl.style.display='block'; }
  </script>
</body>
</html>